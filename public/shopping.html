<!DOCTYPE html>  
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="shopping.css">
    <link rel="stylesheet" href="city.css">
    <title>Document</title>
</head>
<body>
    <header id="demo"></header>
      <div class="gwmk" id="app">  
        <div class="timg">
            <img src="xbCartGoodstit1.gif" alt="">
        </div>
        <div class="limg">
            <img src="xbCarttit01.gif" alt="">
        </div>
        <div class="zd">
            <div class="zd1">
                配送至：<div id="app">
                <city></city></div>
            </div>
            <div class="zd2">
                商品金额总计：<span>￥{{total}}</span>
            </div>
        </div>
        <table class="tab" cellspacing="0">
                <thead>
                    <tr>
                        <td><input type="checkbox" @click='all' v-model="ischecked">全选</td>
                        <td>商品图片</td>
                        <td>商品信息</td>
                        <td>商品编码</td>
                        <td>单价</td>
                        <td>数量</td>
                        <td>小计</td>
                        <td>操作</td>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="(item,i) of list" :key="i">
                        <td><input type="checkbox" v-model="item.ischecked" :data-ischecked="item.ischecked" @click="check"></td>
                        <td class="pimg"><img :src="item.pimg" alt=""></td>
                        <td>{{item.pname}}</td>
                        <td>{{item.pid}}</td>
                        <td class="red">￥{{item.price}}</td>
                        <td class="count">
                            <button @click="change(-1,$event)" :data-pid="item.pid" :data-pname="item.pname" :data-price="item.price" :data-pimg="item.pimg" :data-id="item.id">-</button>
                            <input type="text" v-model="item.count">
                            <button @click="change(1,$event)"  :data-pid="item.pid" :data-pname="item.pname" :data-price="item.price" :data-pimg="item.pimg" :data-id="item.id">+</button>
                        </td>
                        <td class="red" class="xj" :data-pid="item.pid" :data-pname="item.pname" :data-price="item.price" :data-pimg="item.pimg" :data-id="item.id" >￥{{item.price*item.count}}</td>
                        <td class="btn"><button @click="delitem" :data-id="item.id">删除</button></td>  
                    </tr>  
                </tbody>
                <tfoot>
                    <tr>
                        <td><input type="checkbox" @click="all" v-model="ischecked">全选</td>
                        <td><a href="">批量删除</a></td>
                        <td colspan="5"><a href="">下载</a></td>
                        <td>商品金额总计：<span>￥{{total}}</span></td>
                    </tr>
                </tfoot>
            </table>
            <p class="p1">您还需购买<span> ¥318.50</span>，获取积分比例将增加3.3倍！</p>
            <p><span>2</span> 种  商品已选择总数：<span>2</span> 件   购物车里有商品：</p>
            <p>商品金额总计：<span>¥{{total}}</span></p> 
            <div class="butt">
                <button>&lt;继续购物</button>
                <button>提交订单</button>
            </div>
            <div>
                <div class="tj"> <span>推荐商品</span><div>  </div></div>
                <div class="zj">
                    <div class="r2">
                        <div class="c6">
                            <img src="9.jpg" alt="">
                            <a href="">易优百 标准型复印纸 5包/箱 A4 70g
                            </a>
                            <div>现价：¥ 135.00</div>
                            <button>加入购物车</button>
                    </div>
                    <div class="c6">
                          <img src="9.jpg" alt="">
                        <a href="">易优百 标准型复印纸 5包/箱 A4 70g
                        </a>
                        <div>现价：¥ 135.00</div>
                        <button>加入购物车</button>
                    </div>
                    <div class="c6">
                        <img src="9.jpg" alt="">
                        <a href="">易优百 标准型复印纸 5包/箱 A4 70g
                                </a>
                        <div>现价：¥ 135.00</div>
                            <button>加入购物车</button>
                        </div>
                    <div class="c6">
                        <img src="9.jpg" alt="">
                        <a href="">易优百 标准型复印纸 5包/箱 A4 70g
                                </a>
                        <div>现价：¥ 135.00</div>
                            <button>加入购物车</button>
                        </div>
                    <div class="c6">
                        <img src="9.jpg" alt="">
                        <a href="">易优百 标准型复印纸 5包/箱 A4 70g
                                </a>
                        <div>现价：¥ 135.00</div>
                            <button>加入购物车</button>
                    </div>
                    <div class="c6">
                        <img src="9.jpg" alt="">
                        <a href="">易优百 标准型复印纸 5包/箱 A4 70g
                                </a>
                        <div>现价：¥ 135.00</div>
                            <button>加入购物车</button>
                    </div>
                </div>
                <div class="btn2">
                    <button class="in">1</button>
                    <button>2</button>
                </div> 
            </div>
            <p class="pb">温馨提示：您在购物中有任何疑问，请查阅<a href="">帮助中心</a>或<a href="">联系客服</a>！</p>
        </div>
    </div>
    <footer id="footer"></footer>
    <script src="jquery-1.11.3.js"></script>
    <script src="header.js"></script>
    <script src="shopping.js"></script>
    <script src="vue.js"></script>
    <script src="vue-router.js"></script>
    <script src="footer.js"></script>
    <script src="city.js"></script>
    <script>
        var vm=new Vue({
            el:"#app",
            data:{
                list:[],
                uid:1,
                total:0,
                count:8,
                uid:1,
                ps:6,
                pid:"",
                pname:'',
                price:'',
                pimg:'',
                ischecked:false,
            },
            methods:{
                all(){
                    this.ischecked=!this.ischecked;
                    for(var x of this.list){
                        if(this.ischecked){
                            x.ischecked=true;
                        }else if(!this.ischecked){
                            x.ischecked=false;
                        }
                    }
                },
                check(e){
                    //console.log(e.target.parentNode.innerHTML);
                    var c=e.target.dataset.ischecked;
                    if(c==0||!c){
                        c=false;
                    }else{
                        c=true;
                    }
                    c=!c;
                    if(!c){
                        this.ischecked=false;
                    }
                },
                change(n,e){
                    var xj=document.querySelectorAll("tbody>tr");
                        this.total=0;
                    for(var x of xj){
        
                        this.total+=parseFloat(x.children[6].innerHTML.slice(1));
                    }
                    this.pid=e.target.dataset.pid;
                      this.pname=e.target.dataset.pname;
                      this.price=e.target.dataset.price;
                      this.pimg=e.target.dataset.pimg;
                      localStorage.setItem("uid",1);
                      this.uid=localStorage.getItem("uid");
                    if(n==1){
                        var input=e.target.previousElementSibling;
                        var i=input.value;
                        i++;
                        input.value=i; 
                        this.cart();
                        return new Promise((resolve)=>{
                            var xhr=new XMLHttpRequest();
                            xhr.onreadystatechange=function(){
                                if(xhr.readyState==4&&xhr.status==200){
                                    var result=xhr.responseText;
                                    resolve(result);
                                }
                            };  
                            xhr.open("get","http://127.0.0.1:8080/product/addcart?pid="+this.pid+"&pname="+this.pname+"&price="+this.price+"&pimg="+this.pimg+"&uid="+this.uid,true);  
                            xhr.send();  
                        }).then(res=>{  
                        });
                        this.cart();
                    }else if(n==-1){
                        var input=e.target.nextElementSibling;
                        var i=input.value;
                        i--;
                        input.value=i;
                        this.cart();
                        if(i<1){
                            var id=e.target.dataset.id;
                            var tr=e.target.parentNode.parentNode;
                            return new Promise((resolve)=>{
                                var xhr=new XMLHttpRequest();
                                xhr.onreadystatechange=function(){
                                    if(xhr.readyState==4&&xhr.status==200){
                                        var result=JSON.parse(xhr.responseText);
                                        resolve(result);
                                    }
                                };
                                xhr.open("get","http://127.0.0.1:8080/product/delitem?uid="+this.uid+"&id="+id,true);
                                xhr.send();
                            }).then(result=>{
                                tr.remove();
                            });
                        this.cart();
                        }else {
                            return new Promise((resolve)=>{
                                var xhr=new XMLHttpRequest();
                                xhr.onreadystatechange=function(){
                                    if(xhr.readyState==4&&xhr.status==200){
                                        var result=xhr.responseText;
                                        resolve(result);
                                    }
                                };  
                                xhr.open("get","http://127.0.0.1:8080/product/less?pid="+this.pid+"&pname="+this.pname+"&price="+this.price+"&pimg="+this.pimg+"&uid="+this.uid,true);  
                                xhr.send();  
                            }).then(res=>{    
                            });
                            this.cart();
                        }
                    }
                },
                delitem(e){
                    var id=e.target.dataset.id;
                    var tr=e.target.parentNode.parentNode;
                    return new Promise((resolve)=>{
                        var xhr=new XMLHttpRequest();
                        xhr.onreadystatechange=function(){
                            if(xhr.readyState==4&&xhr.status==200){
                                var result=JSON.parse(xhr.responseText);
                                resolve(result);
                            }
                        };
                        xhr.open("get","http://127.0.0.1:8080/product/delitem?uid="+this.uid+"&id="+id,true);
                        xhr.send();
                    }).then(result=>{
                        tr.remove();
                    })
                },
                cart(){
                    return new Promise((resolve)=>{
                        var xhr=new XMLHttpRequest();
                        xhr.onreadystatechange=function(){
                            if(xhr.readyState==4&&xhr.status==200){
                                var result=JSON.parse(xhr.responseText);
                                resolve(result.data);
                            }
                        };
                        xhr.open("get","http://127.0.0.1:8080/product/shopping?uid="+this.uid,true);
                        xhr.send();
                    }).then(result=>{
                        this.list=result;
                        for(var l of this.list){
                            //console.log(l.ischecked);
                            // if(l.ischecked==0){
                            //     l.ischecked=false;
                            // }else{
                            //     l.ischecked=true;
                            // }
                        }
                    })
                },
            },
            created(){
                document.body.onload=this.cart;
            }
        });
    </script>
</body>
</html>